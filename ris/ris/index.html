import os
import io
import mammoth

from flask import Flask, request, jsonify, send_file
from flask_cors import CORS

from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseUpload, MediaIoBaseDownload
from docx import Document

# ================= APP SETUP =================

app = Flask(__name__)
CORS(app)

# ================= GOOGLE DRIVE AUTH =================

SCOPES = ["https://www.googleapis.com/auth/drive"]

CREDS_PATH = os.environ["GOOGLE_APPLICATION_CREDENTIALS"]
DRIVE_ROOT_ID = os.environ["DRIVE_ROOT_ID"]

creds = service_account.Credentials.from_service_account_file(
    CREDS_PATH,
    scopes=SCOPES
)

drive = build("drive", "v3", credentials=creds)

# ================= FOLDER MAPPING (REPLACE IDS) =================
# PUT YOUR REAL GOOGLE DRIVE FOLDER IDs HERE

FOLDERS = {
    "Templates": {
        "CT":   "TEMPLATE_CT_FOLDER_ID",
        "MRI":  "TEMPLATE_MRI_FOLDER_ID",
        "USG":  "TEMPLATE_USG_FOLDER_ID",
        "XRAY": "TEMPLATE_XRAY_FOLDER_ID",
    },
    "Reports": {
        "CT":   "REPORT_CT_FOLDER_ID",
        "MRI":  "REPORT_MRI_FOLDER_ID",
        "USG":  "REPORT_USG_FOLDER_ID",
        "XRAY": "REPORT_XRAY_FOLDER_ID",
    }
}

# ================= ROOT =================

@app.route("/")
def home():
    return jsonify({"status": "ok", "service": "Malwa RIS Backend"})

# ================= WORD â†’ HTML =================

@app.route("/api/word_to_html", methods=["POST"])
def word_to_html():
    f = request.files["file"]
    html = mammoth.convert_to_html(io.BytesIO(f.read())).value
    return jsonify({"html": html})

# ================= LIST TEMPLATES =================

@app.route("/api/templates/<modality>")
def list_templates(modality):
    folder_id = FOLDERS["Templates"].get(modality)
    if not folder_id:
        return jsonify([])

    files = drive.files().list(
        q=f"'{folder_id}' in parents and trashed=false",
        fields="files(id,name)"
    ).execute().get("files", [])

    return jsonify(files)

# ================= LOAD TEMPLATE =================

@app.route("/api/load_template", methods=["POST"])
def load_template():
    file_id = request.json["file_id"]

    req = drive.files().get_media(fileId=file_id)
    fh = io.BytesIO()
    MediaIoBaseDownload(fh, req).next_chunk()
    fh.seek(0)

    html = mammoth.convert_to_html(fh).value
    return jsonify({"html": html})

# ================= UPLOAD TEMPLATE =================

@app.route("/api/upload_template", methods=["POST"])
def upload_template():
    f = request.files["file"]
    modality = request.form["modality"]

    folder_id = FOLDERS["Templates"].get(modality)
    if not folder_id:
        return jsonify({"error": "Invalid modality"}), 400

    media = MediaIoBaseUpload(
        io.BytesIO(f.read()),
        mimetype="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    )

    drive.files().create(
        body={
            "name": f.filename,
            "parents": [folder_id]
        },
        media_body=media
    ).execute()

    return jsonify({"status": "uploaded"})

# ================= SAVE REPORT =================

@app.route("/api/save_report", methods=["POST"])
def save_report():
    data = request.json

    folder_id = FOLDERS["Reports"].get(data["modality"])
    if not folder_id:
        return jsonify({"error": "Invalid modality"}), 400

    doc = Document()
    text = data["html"].replace("<p>", "").replace("</p>", "\n")
    for line in text.split("\n"):
        if line.strip():
            doc.add_paragraph(line)

    buf = io.BytesIO()
    doc.save(buf)
    buf.seek(0)

    media = MediaIoBaseUpload(
        buf,
        mimetype="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    )

    filename = f"{data['patient_name']}_{data['uhid']}_{data['date']}.docx"

    file = drive.files().create(
        body={
            "name": filename,
            "parents": [folder_id]
        },
        media_body=media,
        fields="id"
    ).execute()

    return jsonify({"status": "saved", "id": file["id"]})

# ================= LIST REPORTS =================

@app.route("/api/reports")
def reports():
    patient = request.args.get("patient_name", "").lower()
    uhid = request.args.get("uhid", "").lower()
    date = request.args.get("date", "")

    results = []

    for modality, folder_id in FOLDERS["Reports"].items():
        files = drive.files().list(
            q=f"'{folder_id}' in parents and trashed=false",
            fields="files(id,name)"
        ).execute().get("files", [])

        for f in files:
            name = f["name"].lower()
            if patient and patient not in name:
                continue
            if uhid and uhid not in name:
                continue
            if date and date not in name:
                continue

            parts = f["name"].rsplit("_", 2)
            if len(parts) == 3:
                results.append({
                    "id": f["id"],
                    "patient_name": parts[0],
                    "uhid": parts[1],
                    "date": parts[2].replace(".docx", ""),
                    "modality": modality
                })

    return jsonify(results)

# ================= DOWNLOAD REPORT =================

@app.route("/api/download_word/<file_id>")
def download_word(file_id):
    req = drive.files().get_media(fileId=file_id)
    fh = io.BytesIO()
    MediaIoBaseDownload(fh, req).next_chunk()
    fh.seek(0)

    return send_file(
        fh,
        as_attachment=True,
        download_name="report.docx"
    )

# ================= RUN =================

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 10000)))




