<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Malwa RIS</title>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
body{
    font-family:Segoe UI, Arial;
    background:#f3f6fb;
    padding:20px;
}
.container{
    background:white;
    padding:20px;
    border-radius:10px;
    max-width:1200px;
    margin:auto;
}
.grid{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    margin-bottom:10px;
}
input,select{
    padding:8px;
    border-radius:6px;
    border:1px solid #cbd5e1;
}
button{
    padding:10px 14px;
    border:none;
    border-radius:6px;
    color:white;
    font-weight:600;
    cursor:pointer;
}
.blue{background:#2563eb}
.green{background:#16a34a}
.orange{background:#ea580c}
.purple{background:#7c3aed}

#editor{
    height:520px;
    background:white;
    margin-top:10px;
}

.actions{
    margin-top:10px;
    display:flex;
    gap:10px;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th,td{
    border:1px solid #cbd5e1;
    padding:8px;
    font-size:13px;
}
th{background:#f1f5f9}
</style>
</head>

<body>
<div class="container">

<h2>Malwa RIS</h2>

<!-- PATIENT DETAILS -->
<div class="grid">
    <input id="patientName" placeholder="Patient Name">
    <input id="uhid" placeholder="UHID">
    <select id="modality">
        <option>CT</option>
        <option>MRI</option>
        <option>XRAY</option>
        <option>USG</option>
    </select>
    <input id="study" placeholder="Study / Region">
</div>

<!-- TEMPLATE CONTROLS -->
<div class="grid">
    <select id="templateSelect"></select>
    <button class="blue" onclick="loadTemplate()">Load Template (Drive)</button>
    <input type="file" id="templateUpload" accept=".docx">
    <button class="purple" onclick="uploadTemplate()">Upload Template (PC)</button>
</div>

<!-- WORD UPLOAD -->
<div class="grid">
    <input type="file" id="wordUpload" accept=".docx">
    <button class="orange" onclick="uploadWord()">Upload Report (Word)</button>
</div>

<!-- EDITOR -->
<div id="editor"></div>

<!-- ACTIONS -->
<div class="actions">
    <button class="green" onclick="saveReport()">Save Report (HTML â†’ Drive)</button>
    <button class="blue" onclick="fetchReports()">Fetch Reports</button>
</div>

<!-- SEARCH REPORTS -->
<div class="grid">
    <input id="searchName" placeholder="Search Patient Name">
    <input id="searchUHID" placeholder="Search UHID">
    <input id="searchDate" type="date">
    <button class="blue" onclick="fetchReports()">Search</button>
</div>

<!-- REPORT LIST -->
<table>
<thead>
<tr>
    <th>Modality</th>
    <th>Patient | UHID | Date</th>
    <th>Download (Word)</th>
</tr>
</thead>
<tbody id="reportTable"></tbody>
</table>

</div>

<script>
const API_BASE = "https://malwa-ris-backend.onrender.com";

const modality        = document.getElementById("modality");
const templateSelect  = document.getElementById("templateSelect");
const patientName     = document.getElementById("patientName");
const uhid            = document.getElementById("uhid");
const study           = document.getElementById("study");
const wordUpload      = document.getElementById("wordUpload");
const templateUpload  = document.getElementById("templateUpload");
const reportTable     = document.getElementById("reportTable");
const searchName      = document.getElementById("searchName");
const searchUHID      = document.getElementById("searchUHID");
const searchDate      = document.getElementById("searchDate");

const quill = new Quill("#editor", {
  theme: "snow",
  modules: {
    toolbar: [
      [{ header: [1, 2, 3, false] }],
      [{ font: [] }],
      [{ size: ["small", false, "large", "huge"] }],
      ["bold", "italic", "underline"],
      [{ color: [] }, { background: [] }],
      [{ align: [] }],
      [{ list: "ordered" }, { list: "bullet" }],
      ["clean"]
    ]
  }
});

modality.addEventListener("change", loadTemplates);
loadTemplates();

function loadTemplates(){
    templateSelect.innerHTML = "<option>Loading...</option>";
    fetch(`${API_BASE}/api/templates/${modality.value}`)
      .then(r => r.json())
      .then(list => {
        templateSelect.innerHTML = "";
        list.forEach(t => {
          templateSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });
      });
}

function loadTemplate(){
    if(!templateSelect.value) return alert("Select template");
    fetch(API_BASE + "/api/load_template", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ file_id: templateSelect.value })
    })
    .then(r => r.json())
    .then(d => quill.root.innerHTML = d.html);
}

function uploadTemplate(){
    if(!templateUpload.files[0]) return alert("Select template Word file");
    const fd = new FormData();
    fd.append("file", templateUpload.files[0]);
    fd.append("modality", modality.value);

    fetch(API_BASE + "/api/upload_template", { method:"POST", body: fd })
      .then(() => loadTemplates());
}

function uploadWord(){
    if(!wordUpload.files[0]) return alert("Select Word file");
    const fd = new FormData();
    fd.append("file", wordUpload.files[0]);

    fetch(API_BASE + "/api/word_to_html", { method:"POST", body: fd })
      .then(r => r.json())
      .then(d => quill.root.innerHTML = d.html);
}

function saveReport(){
    if(!patientName.value || !uhid.value) return alert("Patient Name and UHID required");

    fetch(API_BASE + "/api/save_report", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            patient_name: patientName.value,
            uhid: uhid.value,
            modality: modality.value,
            study: study.value,
            date: new Date().toISOString().slice(0,10),
            html: quill.root.innerHTML
        })
    }).then(() => alert("Report saved to Drive"));
}

function fetchReports(){
    const params = new URLSearchParams({
        patient_name: searchName.value || "",
        uhid: searchUHID.value || "",
        date: searchDate.value || ""
    });

    fetch(`${API_BASE}/api/reports?${params.toString()}`)
    .then(r => r.json())
    .then(list => {
        reportTable.innerHTML = "";
        list.forEach(r => {
            reportTable.innerHTML += `
            <tr>
                <td>${r.modality}</td>
                <td>${r.patient_name} | ${r.uhid} | ${r.date}</td>
                <td><a href="${API_BASE}/api/download_word/${r.id}" target="_blank">Download</a></td>
            </tr>`;
        });
    });
}
</script>

</body>
</html>






